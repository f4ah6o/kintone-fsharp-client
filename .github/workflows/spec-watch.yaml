name: Spec Watch

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  watch:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - id: local
        name: Read local spec version
        run: |
          version=$(cat openapi/kintone/version.txt)
          echo "version=$version" >> "$GITHUB_OUTPUT"

      - id: upstream
        name: Fetch upstream version list
        uses: actions/github-script@v7
        with:
          script: |
            const response = await github.request('GET /repos/{owner}/{repo}/contents/{path}', {
              owner: 'kintone',
              repo: 'rest-api-spec',
              path: 'kintone'
            });
            const versions = response.data
              .filter(item => item.type === 'dir')
              .map(item => item.name)
              .sort();
            if (versions.length === 0) {
              core.setFailed('No upstream versions found.');
              return;
            }
            const latest = versions[versions.length - 1];
            core.setOutput('latest', latest);
            const localVersion = '${{ steps.local.outputs.version }}';
            const needsIssue = latest > localVersion;
            core.setOutput('needs-issue', needsIssue.toString());
            core.info(`Local: ${localVersion} / Upstream: ${latest}`);

      - name: Create tracking issue
        if: steps.upstream.outputs.needs-issue == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const localVersion = '${{ steps.local.outputs.version }}';
            const latestVersion = '${{ steps.upstream.outputs.latest }}';
            const title = `Upstream Kintone REST API spec ${latestVersion} is available`;
            const query = `repo:${context.repo.owner}/${context.repo.repo} in:title "${latestVersion}" state:open`;
            const search = await github.rest.search.issuesAndPullRequests({ q: query });
            const existing = search.data.items.find(item => item.title === title);
            if (existing) {
              core.info(`Issue already exists: #${existing.number}`);
              return;
            }
            const body = `A newer spec timestamp (${latestVersion}) is published in https://github.com/kintone/rest-api-spec.` +
              `\n\nCurrent repo snapshot: ${localVersion}.` +
              `\n\nAction items:` +
              `\n1. Run \`dotnet run --project tools/SpecSync -- --version ${latestVersion}\`.` +
              `\n2. Review \`openapi/operation-coverage.json\` and tag each new operation.` +
              `\n3. Implement missing client/test coverage and update documentation.`;
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body
            });
            core.info(`Created issue for spec ${latestVersion}`);
